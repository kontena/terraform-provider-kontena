## Requirements

* [Terraform](https://www.terraform.io/downloads.html) 0.10+
* [Go](https://golang.org/doc/install) 1.8+
* [govendor](https://github.com/kardianos/govendor)

## Build

    mkdir -p $GOPATH/src/github.com/kontena
    git clone github.com/kontena/terraform-provider-kontena $GOPATH/src/github.com/kontena/terraform-provider-kontena
    cd $GOPATH/src/github.com/kontena/terraform-provider-kontena
    govendor sync
    go test ./... && go install .

## Setup

See [Installing a Plugin](https://www.terraform.io/docs/plugins/basics.html#installing-a-plugin) from the Terraform docs:

    mkdir -p ~/.terraform.d/plugins
    ln -s $GOPATH/bin/terraform-provider-kontena ~/.terraform.d/plugins/

## Usage

### Supported Kontena versions

Requires Kontena 1.4+

### Supported resources

* `kontena_token`
* `kontena_grid`
* `kontena_node`

### Example `kontena.tf`

Using the oauth2 token generated by `kontena-oauth2_token`:

```
provider "kontena" {
  url = "http://X.Y.Z.W:80"
  token = "cc1f...fb6417"
}

resource "kontena_grid" "test" {
  name = "test"
  initial_size = 1
  trusted_subnets = [ "192.168.66.0/24" ]
}

resource "kontena_node" "node" {
  count = "${var.digitalocean_node_count}"

  grid = "${kontena_grid.grid.name}"
  name = "terraform-test-node${count.index + 1}"

  labels = [
    "provider=digitalocean",
    "region=${var.digitalocean-region}",
    "az=${var.digitalocean-region}",
  ]
}

output "grid_token" {
  value = "${kontena_grid.grid.token}"
}
output "node_token" {
  value = "${kontena_node.node.token}"
}
```

### Bootstrapping oauth2 token from the  `INITIAL_ADMIN_CODE`

If you are provisioning the master itself via terraform with a pre-configured `INITIAL_ADMIN_CODE`, you can use the `kontena_token` resource to exchange the inital admin code for the admin token. You must use a second, aliased instance of the provider to do this:


```
module "digitalocean_master" {
  ...
}

provider "kontena" {
  alias = "master-bootstrap"
  url = "${module.digitalocean_master.http_url}"
}

resource "kontena_token" "admin" {
  provider = "kontena.master-bootstrap"

  code = "${var.kontena-initial_admin_code}"
}

provider "kontena" {
  url = "${module.digitalocean_master.http_url}"
  token = "${kontena_token.admin.token}"
}

output "KONTENA_URI" {
  value = "${module.digitalocean_master.http_url}"
}

output "KOTNENA_TOKEN" {
  value = "${kontena_token.admin.token}"
}
```

## Example
### `terraform show`
```
kontena_token.admin:
  id = 971...
  code = bsF...
  email = admin
  roles.# = 1
  roles.0 = master_admin
  token = 971...
  user = admin

kontena_grid.grid:
  id = test
  default_affinity.# = 0
  initial_size = 1
  name = test
  subnet = 10.81.0.0/16
  supernet = 10.80.0.0/12
  token = Gc...
  trusted_subnets.# = 0

module.digitalocean-node1.kontena_node.node:
  id = test/terraform-test-node1
  agent_version = 1.4.0.pre5
  docker_version = 1.12.6
  grid = test
  initial_node = false
  labels.# = 3
  labels.0 = provider=digitalocean
  labels.1 = region=fra1
  labels.2 = az=fra1
  name = terraform-test-node1
  node_id = AHBV:DHKM:5J3Z:WST3:DO2Q:Q2AG:T6NM:BBYB:QGN5:G4Y6:7GXZ:4QIT
  node_number = 2
  overlay_ip = 10.81.0.2
  private_ip = 207.154.200.134
  public_ip = 207.154.200.134
  token = cNr...343g==
module.digitalocean-node2.kontena_node.node:
  id = test/terraform-test-node2
  agent_version = 1.4.0.pre5
  docker_version = 1.12.6
  grid = test
  initial_node = true
  labels.# = 3
  labels.0 = provider=digitalocean
  labels.1 = region=fra1
  labels.2 = az=fra1
  name = terraform-test-node2
  node_id = PBOE:X2WG:ULOL:O2YJ:6C3L:P32Z:P2Y3:EGAR:27AJ:NMXG:Z2SU:TWFZ
  node_number = 1
  overlay_ip = 10.81.0.1
  private_ip = 46.101.119.165
  public_ip = 46.101.119.165
  token = cFdn...lQ==

```
